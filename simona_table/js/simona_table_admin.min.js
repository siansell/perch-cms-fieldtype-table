"use strict";var allTablesOnPage=[],tablePrefix="simona_hot_",setCulture=function(e){var t=$("#"+e+"_culture").val();numbro.culture(t)},initTables=function(){$("div[id^="+tablePrefix+"]").each(function(){var a=this.id.replace(tablePrefix,"");if(!$.grep(allTablesOnPage,function(e){return e.id===a}).length){var e=$("#"+a+"_fixedCols"),n=$("#"+a+"_data"),t=$("#"+a+"_headers"),r=$("#"+a+"_types"),i=$("#"+a+"_options");setCulture(a);var s=JSON.parse(n.val()),o="true"===e.val(),l=void 0;if(!o){var u=s[0].length;r.attr("value","["+'"text",'.repeat(u).slice(0,-1)+"]"),i.attr("value","["+'"",'.repeat(u).slice(0,-1)+"]")}l='"[]"'===t.val()||JSON.parse(t.val());var c=JSON.parse(r.val()),d=JSON.parse(i.val()),f=void 0;f=!!o&&c.map(function(e,t){var a={type:e},r=d[t],n=r.split(";");switch(e){case"numeric":r&&(a.numericFormat={pattern:r});break;case"date":d[t]&&(a.dateFormat=r,a.correctFormat=!0);break;case"checkbox":a.checkedTemplate=n[0],a.uncheckedTemplate=n[1];break;case"dropdown":a.source=n}return a}),this.setData=function(e){setCulture(a);var r=e.getData(),t=r.map(function(e,a){return e.map(function(e,t){switch(c[t]){case"numeric":return r[a][t]?numbro(r[a][t]).format(d[t]):null;default:return e}})});$(n).val(JSON.stringify(t))},this.setHeaders=function(e){$(t).val(JSON.stringify(e.getColHeader().map(function(e){return e||""})))};var v=this,p=document.getElementById(this.id),h={items:{row_above:{},row_below:{},remove_row:{}}};o||(h.items.hsep1="---------",h.items.col_left={},h.items.col_right={},h.items.remove_col={});var m=new Handsontable(p,{afterChange:function(){v.setData(this)},afterCreateCol:function(){v.setData(this)},afterCreateRow:function(){v.setData(this)},afterGetColHeader:function(){v.setData(this),v.setHeaders(this)},afterRemoveCol:function(){v.setData(this)},afterRemoveRow:function(){v.setData(this)},data:s,colHeaders:l,columns:f,contextMenu:h,manualColumnResize:!0,manualRowResize:!0,rowHeaders:!1});this.setHeaders(m),m.id=a,allTablesOnPage.push(m)}})},getHotFromID=function(t){var e=$.grep(allTablesOnPage,function(e){return e.id===t.replace(tablePrefix,"")});return!!e.length&&e[0]},disablePerchEditButtons=function(e){$('input[type="submit"]#btnsubmit').prop("disabled",e),$('input[type="submit"]#add_another').prop("disabled",e)},editColHeaders=function(a,e){var t=getHotFromID(a);t.hasColHeaders()&&!1!==t&&($(e).hide(),$("#"+e.id.replace("edit","save")).show(),disablePerchEditButtons(!0),t.updateSettings({colHeaders:t.getColHeader().map(function(e,t){return'<input type="text" onchange="javascript:saveHeader(\''+a+"',"+t+',$(this).val());" value="'+e+'" />'}),afterOnCellMouseDown:function(e,t){-1===t.row&&this.getInstance().deselectCell()}}))},saveColHeaders=function(e,t){var a=getHotFromID(e);a.hasColHeaders()&&!1!==a&&($(t).hide(),$("#"+t.id.replace("save","edit")).show(),a.updateSettings({colHeaders:a.getColHeader().map(function(e){return $(e).attr("value")})}),disablePerchEditButtons(!1))},saveHeader=function(e,a,r){var t=getHotFromID(e);t.hasColHeaders()&&!1!==t&&t.updateSettings({colHeaders:t.getColHeader().map(function(e,t){return t===a?e.replace(/value=".*"/,'value="'+r+'"'):e})})};$(window).on("Perch_Init_Editors",initTables),initTables();