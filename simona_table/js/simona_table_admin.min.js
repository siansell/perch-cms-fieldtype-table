"use strict";var allTablesOnPage=[],tablePrefix="simona_hot_",setCulture=function(e){var t=$("#"+e+"_culture").val();numbro.culture(t)},initTables=function(){$("div[id^="+tablePrefix+"]").each(function(){var a=this.id.replace(tablePrefix,"");if(!$.grep(allTablesOnPage,function(e){return e.id===a}).length){var n=$("#"+a+"_data"),t=$("#"+a+"_headers"),e=$("#"+a+"_types"),r=$("#"+a+"_options");setCulture(a);var s=JSON.parse(n.val()),i=JSON.parse(t.val()),o=JSON.parse(e.val()),l=JSON.parse(r.val()),u=o.map(function(e,t){var a={type:e},r=l[t],n=r.split(";");switch(e){case"numeric":r&&(a.numericFormat={pattern:r});break;case"date":l[t]&&(a.dateFormat=r,a.correctFormat=!0);break;case"checkbox":a.checkedTemplate=n[0],a.uncheckedTemplate=n[1];break;case"dropdown":a.source=n}return a});this.setData=function(e){setCulture(a);var r=e.getData(),t=r.map(function(e,a){return e.map(function(e,t){switch(o[t]){case"numeric":return r[a][t]?numbro(r[a][t]).format(l[t]):null;default:return e}})});$(n).val(JSON.stringify(t))},this.setHeaders=function(e){$(t).val(JSON.stringify(e.getColHeader().map(function(e){return e||""})))};var c=this,d=document.getElementById(this.id),f=new Handsontable(d,{afterChange:function(){c.setData(this)},afterCreateCol:function(){c.setData(this)},afterCreateRow:function(){c.setData(this)},afterGetColHeader:function(){c.setData(this),c.setHeaders(this)},afterRemoveCol:function(){c.setData(this)},afterRemoveRow:function(){c.setData(this)},data:s,colHeaders:i,columns:u,contextMenu:{items:{row_above:{},row_below:{},remove_row:{}}},manualColumnResize:!0,manualRowResize:!0,rowHeaders:!1});this.setHeaders(f),f.id=a,allTablesOnPage.push(f)}})},getHotFromID=function(t){var e=$.grep(allTablesOnPage,function(e){return e.id===t.replace(tablePrefix,"")});return!!e.length&&e[0]},disablePerchEditButtons=function(e){$('input[type="submit"]#btnsubmit').prop("disabled",e),$('input[type="submit"]#add_another').prop("disabled",e)},editColHeaders=function(a,e){var t=getHotFromID(a);t.hasColHeaders()&&!1!==t&&($(e).hide(),$("#"+e.id.replace("edit","save")).show(),disablePerchEditButtons(!0),t.updateSettings({colHeaders:t.getColHeader().map(function(e,t){return'<input type="text" onchange="javascript:saveHeader(\''+a+"',"+t+',$(this).val());" value="'+e+'" />'}),afterOnCellMouseDown:function(e,t){-1===t.row&&this.getInstance().deselectCell()}}))},saveColHeaders=function(e,t){var a=getHotFromID(e);a.hasColHeaders()&&!1!==a&&($(t).hide(),$("#"+t.id.replace("save","edit")).show(),a.updateSettings({colHeaders:a.getColHeader().map(function(e){return $(e).attr("value")})}),disablePerchEditButtons(!1))},saveHeader=function(e,a,r){var t=getHotFromID(e);t.hasColHeaders()&&!1!==t&&t.updateSettings({colHeaders:t.getColHeader().map(function(e,t){return t===a?e.replace(/value=".*"/,'value="'+r+'"'):e})})};$(window).on("Perch_Init_Editors",initTables),initTables();